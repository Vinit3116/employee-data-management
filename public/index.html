<!-- /public/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Data Management</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    #addBtn {
      height: 38px; 
      padding: 0 10px;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">üë®‚Äçüíª Employee Data Management</a>
  </div>
</nav>

<div class="container py-4">

  <!-- Add Employee Form -->
  <div class="card shadow-lg mb-4">
    <div class="card-header bg-primary text-white fw-bold">Add Employee</div>
    <div class="card-body">
      <form id="employeeForm" class="row g-3 needs-validation align-items-start" novalidate>
        <!-- Name input -->
        <div class="col-md-3">
          <input type="text" id="name" class="form-control" placeholder="Name" required>
          <div class="invalid-feedback">Please enter a name.</div>
        </div>
        <!-- Email input -->
        <div class="col-md-3">
          <input type="email" id="email" class="form-control" placeholder="Email" required>
          <div class="invalid-feedback">Enter a valid email (.com or .in).</div>
        </div>
        <!-- Position input -->
        <div class="col-md-3">
          <input type="text" id="position" class="form-control" placeholder="Position" required>
          <div class="invalid-feedback">Please enter a position.</div>
        </div>
        <!-- Salary input -->
        <div class="col-md-2">
          <input type="number" id="salary" class="form-control" placeholder="Salary" required>
          <div class="invalid-feedback">Salary must be at least 5000.</div>
        </div>
        <!-- Submit button -->
        <div class="col-md-1">
          <button type="submit" class="btn btn-success w-100" id="addBtn" disabled>
            <i class="bi bi-plus-circle"></i> Add
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Search bar -->
  <input type="text" id="searchBar" class="form-control mb-3" placeholder="üîç Search employees by name...">

  <!-- Employee Table -->
  <div class="card shadow-lg">
    <div class="card-header bg-secondary text-white fw-bold">Employees</div>
    <div class="card-body">
      <table class="table table-striped table-hover align-middle" id="employeeTable">
        <thead class="table-dark">
          <tr>
            <!-- Sortable columns -->
            <th data-field="id" class="sortable">ID <span class="sort-indicator">‚ñ≤</span></th>
            <th data-field="name" class="sortable">Name <span class="sort-indicator">‚ñ≤</span></th>
            <th>Email</th>
            <th>Position</th>
            <th data-field="salary" class="sortable">Salary (‚Çπ) <span class="sort-indicator">‚ñ≤</span></th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit Employee Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content shadow">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">Edit Employee</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editForm" class="needs-validation" novalidate>
          <input type="hidden" id="editId">
          <!-- Edit Name -->
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" id="editName" class="form-control" required>
            <div class="invalid-feedback">Please enter a name.</div>
          </div>
          <!-- Edit Email -->
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="editEmail" class="form-control" required>
            <div class="invalid-feedback">Enter a valid email.</div>
          </div>
          <!-- Edit Position -->
          <div class="mb-3">
            <label class="form-label">Position</label>
            <input type="text" id="editPosition" class="form-control" required>
            <div class="invalid-feedback">Please enter a position.</div>
          </div>
          <!-- Edit Salary -->
          <div class="mb-3">
            <label class="form-label">Salary</label>
            <input type="number" id="editSalary" class="form-control" required>
            <div class="invalid-feedback">Salary must be at least 5000.</div>
          </div>
          <button type="submit" class="btn btn-warning"><i class="bi bi-save"></i> Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Toast container for notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ------------------- DOM Elements ------------------- */
const form = document.getElementById("employeeForm");
const employeeTable = document.querySelector("#employeeTable tbody");
const searchBar = document.getElementById("searchBar");
const editModal = new bootstrap.Modal(document.getElementById("editModal"));
const editForm = document.getElementById("editForm");
const addBtn = document.getElementById("addBtn");
const toastContainer = document.getElementById("toastContainer");
const emailInput = document.getElementById("email");
const salaryInput = document.getElementById("salary");
const editSalaryInput = document.getElementById("editSalary");

/* ------------------- State ------------------- */
let employees = []; // Stores all employee objects
let sortField = null; // Current sorting column
let sortAsc = true;   // Sorting order

/* ------------------- Validation ------------------- */
// Live email validation (.com / .in only)
emailInput.addEventListener("input", () => {
  const value = emailInput.value.trim();
  const valid = /^[^\s@]+@[^\s@]+\.(com|in)$/i.test(value);

  if (valid) {
    emailInput.classList.remove("is-invalid");
    emailInput.classList.add("is-valid");
  } else {
    emailInput.classList.remove("is-valid");
    if (value.length > 0) emailInput.classList.add("is-invalid");
    else emailInput.classList.remove("is-invalid");
  }
  validateForm();
});

// Salary validation (Add form)
salaryInput.addEventListener("input", () => {
  const value = parseFloat(salaryInput.value);
  if (!isNaN(value) && value >= 5000) {
    salaryInput.classList.remove("is-invalid");
    salaryInput.classList.add("is-valid");
  } else {
    salaryInput.classList.remove("is-valid");
    if (salaryInput.value.length > 0) salaryInput.classList.add("is-invalid");
    else salaryInput.classList.remove("is-invalid");
  }
  validateForm();
});

// Salary validation (Edit form)
editSalaryInput.addEventListener("input", () => {
  const value = parseFloat(editSalaryInput.value);
  if (!isNaN(value) && value >= 5000) {
    editSalaryInput.classList.remove("is-invalid");
    editSalaryInput.classList.add("is-valid");
  } else {
    editSalaryInput.classList.remove("is-valid");
    if (editSalaryInput.value.length > 0) editSalaryInput.classList.add("is-invalid");
    else editSalaryInput.classList.remove("is-invalid");
  }
});

/* ------------------- Form validation ------------------- */
const fields = ["name","email","position","salary"];
const validateForm = () => {
  // Enable submit button only if all fields are valid
  const valid = fields.every(f => {
    const el = document.getElementById(f);
    if (f === "salary") {
      return el.value && parseFloat(el.value) >= 5000;
    }
    return el.checkValidity();
  });
  addBtn.disabled = !valid;
};
fields.forEach(f => document.getElementById(f).addEventListener("input", validateForm));

/* ------------------- Toast Notifications ------------------- */
function showToast(message, type="success") {
  const toastEl = document.createElement("div");
  toastEl.className = `toast align-items-center text-bg-${type} border-0`;
  toastEl.role = "alert";
  toastEl.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>`;
  toastContainer.appendChild(toastEl);
  const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
  toast.show();
  toastEl.addEventListener("hidden.bs.toast", () => toastEl.remove());
}

/* ------------------- Fetch & Render Employees ------------------- */
async function fetchEmployees(query="") {
  const res = await fetch("/api/employees");
  const result = await res.json();
  employees = result.data || []; // ‚úÖ backend always sends {ok:true,data:[]}
  renderTable(query);
}

// Render employee table with optional search highlighting
function renderTable(query="") {
  let data = [...employees];

  if(query) {
    const q = query.toLowerCase();
    data = data.map(e => {
      const regex = new RegExp(`(${q})`, "gi");
      e.highlightedName = e.name.replace(regex, '<span class="highlight">$1</span>');
      return e;
    }).filter(e => e.name.toLowerCase().includes(q));
  }

  /* ------------------- Sorting ------------------- */
  if(sortField){
    data.sort((a,b) => {
      let valA = a[sortField];
      let valB = b[sortField];

      // Handle string vs number
      if(typeof valA === "string") valA = valA.toLowerCase();
      if(typeof valB === "string") valB = valB.toLowerCase();

      if(valA < valB) return sortAsc ? -1 : 1;
      if(valA > valB) return sortAsc ? 1 : -1;
      return 0;
    });
  }

  employeeTable.innerHTML = data.map(e => `
    <tr>
      <td>${e.id}</td>
      <td>${e.highlightedName || e.name}</td>
      <td>${e.email}</td>
      <td>${e.position}</td>
      <td>‚Çπ${e.salary}</td>
      <td>
        <button class="btn btn-sm btn-warning me-2" onclick="openEdit(${e.id}, '${e.name}', '${e.email}', '${e.position}', ${e.salary})">
          <i class="bi bi-pencil-square"></i>
        </button>
        <button class="btn btn-sm btn-danger" onclick="deleteEmployee(${e.id})">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    </tr>
  `).join("");
}

/* ------------------- CRUD Operations ------------------- */
// Add employee
form.addEventListener("submit", async e => {
  e.preventDefault();
  const employee = {
    name: document.getElementById("name").value,
    email: document.getElementById("email").value,
    position: document.getElementById("position").value,
    salary: document.getElementById("salary").value
  };
  const res = await fetch("/api/employees", { 
    method: "POST", 
    headers: {"Content-Type":"application/json"}, 
    body: JSON.stringify(employee) 
  });
  const data = await res.json();
  if(data.ok){
    showToast("Employee added successfully ‚úÖ");
    form.reset(); addBtn.disabled = true;
    emailInput.classList.remove("is-valid","is-invalid");
    salaryInput.classList.remove("is-valid","is-invalid");
    fetchEmployees();
  } else {
    showToast(data.error || "Error adding employee ‚ùå", "danger");
  }
});

// Open edit modal and populate fields
function openEdit(id, name, email, position, salary){
  document.getElementById("editId").value = id;
  document.getElementById("editName").value = name;
  document.getElementById("editEmail").value = email;
  document.getElementById("editPosition").value = position;
  document.getElementById("editSalary").value = salary;
  editModal.show();
}

// Submit edit form
editForm.addEventListener("submit", async e => {
  e.preventDefault();
  const id = document.getElementById("editId").value;
  const employee = {
    name: document.getElementById("editName").value,
    email: document.getElementById("editEmail").value,
    position: document.getElementById("editPosition").value,
    salary: document.getElementById("editSalary").value
  };
  const res = await fetch(`/api/employees/${id}`, { 
    method: "PUT", 
    headers: {"Content-Type":"application/json"}, 
    body: JSON.stringify(employee) 
  });
  const data = await res.json();
  if(data.ok){
    showToast("Employee updated ‚úèÔ∏è");
    editModal.hide();
    fetchEmployees();
  } else {
    showToast(data.error || "Error updating employee ‚ùå", "danger");
  }
});

// Delete employee
async function deleteEmployee(id){
  if(confirm("Are you sure to delete?")){
    const res = await fetch(`/api/employees/${id}`, { method: "DELETE" });
    const data = await res.json();
    if(data.ok){
      showToast("Employee deleted ‚ùå", "warning");
      fetchEmployees();
    } else {
      showToast(data.error || "Error deleting employee", "danger");
    }
  }
}

/* ------------------- Search ------------------- */
searchBar.addEventListener("input", e => renderTable(e.target.value));

/* ------------------- Sorting ------------------- */
document.querySelectorAll("th.sortable").forEach(th => {
  th.addEventListener("click", () => {
    const field = th.dataset.field;

    // Reset other columns
    document.querySelectorAll("th.sortable").forEach(th2 => {
      th2.classList.remove("asc","desc");
      th2.querySelector(".sort-indicator").textContent = "‚ñ≤";
    });

    if(sortField === field) sortAsc = !sortAsc;
    else sortAsc = true;
    sortField = field;

    th.classList.add(sortAsc ? "asc" : "desc");
    th.querySelector(".sort-indicator").textContent = sortAsc ? "‚ñ≤" : "‚ñº";

    renderTable(searchBar.value);
  });
});

/* ------------------- Initial fetch ------------------- */
fetchEmployees();
</script>
</body>
</html>
